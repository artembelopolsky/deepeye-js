<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles/main.css">
    <script src="./utils/parameters.js"></script>
    <script src="jatos.js"></script>
    <script src="js/eyetrack_html.js" type="module"></script>

    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-image-keyboard-response.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.2"></script>


    
    <title>Test Tracker</title>
</head>
<body>
    <div>
      <a> SOME TEST TEXT </a>
    </div>
    <script src="js/lib/face-api.js"></script>
    <script src="utils/parameters.js"></script>
    <script src="./js/eyetracker.js" type="module"></script>
    <link rel="preload" href="./js/lib/p5.min_mod.js" as="script"></link>
    <script src="./js/p5setup.js" type="module"></script>
    <script src="./js/p5jsDraw.js" type="module"></script>
  
    
   
    


    <!-- <script
    jatos.onLoad(function() {
      src="eyetracker.js"
      type="module" 
      });
    >
    </script> -->
    
    <script>     
      
      /* initialize jsPsych */
      
      
      var jsPsych = initJsPsych({     
        on_finish: () => jatos.endStudy(jsPsych.data.get().json())
      });

  
      /* create timeline */
      var timeline = [];

      
  
      /* preload images */
      var preload = {
        type: jsPsychPreload,
        images: [
          "img/image_r_402.jpg",
          "img/image_r_508.jpg",
          "img/image_r_677.jpg", 
          "img/image_r_731.jpg",
          "img/image_r_799.jpg"
          ]
      };
      timeline.push(preload);
  
      /* define welcome message trial */
      var welcome = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "Welcome to the experiment. Press any key to begin."
      };
      timeline.push(welcome);
  
      /* define instructions trial */
      var instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <p>In this experiment, an image will appear in the center 
          of the screen.</p>           
          <p>Press any key to begin.</p>
        `,
        post_trial_gap: 2000
      };
      timeline.push(instructions);
  
      /* define trial stimuli array for timeline variables */
      var test_stimuli = [
        { stimulus: "img/image_r_402.jpg",  correct_response: 'f'},
        { stimulus: "img/image_r_508.jpg",  correct_response: 'f'},
        { stimulus: "img/image_r_677.jpg",  correct_response: 'f'},
        { stimulus: "img/image_r_731.jpg",  correct_response: 'f'},
        { stimulus: "img/image_r_799.jpg",  correct_response: 'f'},

        
      ];     

            
      var setup_eyeTracker = {
          type: jsPsychCallFunction,
          async: true,
          func: function(done){

            eyetracker.setup(done);
            
            
          }
        }
       
              
      timeline.push(setup_eyeTracker);

      var calibrate = {
          type: jsPsychCallFunction,
          async: true,
          func: function(done){
            eyetracker.calibrate(done, undefined, numCalibDots=13);        
          }
        }
       
              
      timeline.push(calibrate);
      
      
      // make fullscreen;
      var fullscreenOn = {
        type: jsPsychFullscreen,
        fullscreen_mode: true
      };

      timeline.push(fullscreenOn);
  
      /* define fixation trial element */
      var fixation = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div style="font-size:60px;">+</div>',
        choices: "NO_KEYS",
        trial_duration: 1000,
        // trial_duration: function(){
        //   return jsPsych.randomization.sampleWithoutReplacement([750, 1000, 1250], 1)[0];
        // },
        data: {
          task: 'fixation'
        },
        on_load: function(){            

            // console.log('Debugging mode fixation plugin...');
            eyetracker.record(fixation.trial_duration, fixation.data.task);

            }
      };

  
      /* define stimulus trial element*/
      var test = {
        type: jsPsychImageKeyboardResponse,
        stimulus: jsPsych.timelineVariable('stimulus'),
        choices: ['f', 'j'],
        trial_duration: 1000,
        stimulus_width: Math.floor(system_info.screen_resolution[0]/system_info.scrW_cm * 15),
        stimulis_height: 1000,
        data: {
          task: 'image_on',
          correct_response: jsPsych.timelineVariable('correct_response')
        },
        on_load: function(){          
          
          // console.log('Debugging mode image plugin...');
          // console.log(`screen width is: ${Math.floor(system_info.screen_resolution[0]/system_info.scrW_cm * 15)}`);
          eyetracker.record(test.trial_duration, test.data.task);
          
        },

        on_finish: function(data){
          data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
        }
      };
  
      /* define test procedure */
      var test_procedure = {
        timeline: [fixation, test],
        timeline_variables: test_stimuli,
        repetitions: 1,
        randomize_order: true,
        conditional_function: function() {
                   
          console.log('This conditional function will execute first.')
          
          // debug by hard coding the participant-id
          // console.log('Debugging mode: using existing calibration procedure')
          // eyetracker.paramHandler.session_timestamp = '2023_01_17_13_09_53';
          // eyetracker.init_webcam();

        },
        on_timeline_start: function() {
          
          console.log('This timeline has started');         
          eyetracker.FrameDataLog.trialNr += 1;
          console.log(`trialNr: ${eyetracker.FrameDataLog.trialNr}`);
        }
        
        
      };
      timeline.push(test_procedure);
      
      // validation only block
      var validate = {
          type: jsPsychCallFunction,
          async: true,
          func: function(done){

            eyetracker.calibrate(done, validationOnly=true, numCalibDots=25); 
            
            
          }
        }
       
              
      timeline.push(validate);
      
      // second calibration block
      // timeline.push(calibrate);
  
      /* define debrief */
      var debrief_block = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
  
          var trials = jsPsych.data.get().filter({task: 'response'});
          var correct_trials = trials.filter({correct: true});
          var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
          var rt = Math.round(correct_trials.select('rt').mean());
  
          return `<p>You responded correctly on ${accuracy}% of the trials.</p>
            <p>Your average response time was ${rt}ms.</p>
            <p>Press any key to complete the experiment. Thank you!</p>`;
  
        }
      };
      timeline.push(debrief_block);
  
      /* start the experiment */
      jatos.onLoad(() => {
        jatos.addAbortButton();
        jsPsych.run(timeline);
      });

      
  
    </script>


    
    
</body>
</html>